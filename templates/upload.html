{% extends "base.html" %}
{% block title %}Upload Photo{% endblock %}
{% block styles %}
.container {
    max-width: 600px;
    margin: 20px auto;
    padding: 30px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
h1 { color: #8FA89E; margin-bottom: 10px; }
.subtitle { color: #666; margin-bottom: 30px; }
.form-group { margin-bottom: 20px; }
label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #333;
}
input[type="file"] {
    display: block;
    width: 100%;
    padding: 12px;
    border: 2px dashed #8FA89E;
    border-radius: 10px;
    background: #f5f8f7;
}
textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-family: inherit;
    font-size: 16px;
    min-height: 100px;
}
.btn {
    width: 100%;
    padding: 15px;
    background: #8FA89E;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s;
}
.btn:hover { transform: scale(1.02); }
.btn:disabled { background: #ccc; cursor: not-allowed; }
.message {
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: none;
}
.success { background: #d4edda; color: #155724; display: block; }
.error { background: #f8d7da; color: #721c24; display: block; }
#preview { max-width: 100%; margin-top: 10px; border-radius: 10px; display: none; }
.progress-container {
    display: none;
    margin-bottom: 20px;
}
.progress-container.show {
    display: block;
}
.progress-bar-bg {
    width: 100%;
    height: 24px;
    background: #e9ecef;
    border-radius: 12px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #8FA89E 0%, #7a9a8f 100%);
    border-radius: 12px;
    width: 0%;
    transition: width 0.2s ease;
}
.progress-text {
    text-align: center;
    margin-top: 8px;
    font-size: 14px;
    color: #666;
}
{% endblock %}
{% block content %}
<div class="container">
    <h1>Life Lessons for Baby Andreassi</h1>
    <p class="subtitle">Share your favorite photos of Lauren & Nick being silly, adventurous, wise, or just themselves - then caption it with advice for Baby as demonstrated by Mom & Dad!</p>

    <div id="message" class="message"></div>

    <div id="progressContainer" class="progress-container">
        <div class="progress-bar-bg">
            <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="progressText" class="progress-text">Uploading... 0%</div>
    </div>

    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="photo">Choose Photo</label>
            <input type="file" id="photo" name="photo" accept="image/*" required>
            <img id="preview" alt="Preview">
        </div>

        <div class="form-group">
            <label for="caption">Advice for Baby</label>
            <textarea id="caption" name="caption" placeholder="Caption this moment with a message to Baby Andreassi" required maxlength="500"></textarea>
            <small style="color: #666;">Keep it short and sweet! (Max 500 characters)</small>
        </div>

        <button type="submit" class="btn">Submit</button>
    </form>
</div>
{% endblock %}
{% block scripts %}
<script>
// Photo preview
document.getElementById('photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('preview');
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// Form submission with progress tracking
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const btn = this.querySelector('button');
    const message = document.getElementById('message');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const formData = new FormData(this);
    const form = this;

    btn.disabled = true;
    btn.textContent = 'Uploading...';
    message.style.display = 'none';
    progressContainer.classList.add('show');
    progressBar.style.width = '0%';
    progressText.textContent = 'Uploading... 0%';

    const xhr = new XMLHttpRequest();

    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';

            if (percent < 100) {
                progressText.textContent = `Uploading... ${percent}%`;
            } else {
                progressText.textContent = 'Consulting the parenting experts...';
            }
        }
    });

    // Handle completion
    xhr.addEventListener('load', function() {
        progressContainer.classList.remove('show');
        btn.disabled = false;
        btn.textContent = 'Submit';

        try {
            const result = JSON.parse(xhr.responseText);

            if (xhr.status >= 200 && xhr.status < 300) {
                message.className = 'message success';
                message.textContent = result.message || 'Photo uploaded successfully!';
                message.style.display = 'block';
                form.reset();
                document.getElementById('preview').style.display = 'none';
            } else {
                throw new Error(result.error || 'Upload failed');
            }
        } catch (error) {
            message.className = 'message error';
            message.textContent = 'Upload failed: ' + error.message;
            message.style.display = 'block';
        }

        window.scrollTo(0, 0);
    });

    // Handle network errors
    xhr.addEventListener('error', function() {
        progressContainer.classList.remove('show');
        btn.disabled = false;
        btn.textContent = 'Submit';
        message.className = 'message error';
        message.textContent = 'Upload failed: Network error. Please try again.';
        message.style.display = 'block';
        window.scrollTo(0, 0);
    });

    xhr.open('POST', '/upload');
    xhr.send(formData);
});
</script>
{% endblock %}