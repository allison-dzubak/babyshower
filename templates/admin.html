{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block styles %}
.container {
    max-width: 1400px;
    margin: 20px auto;
    padding: 30px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
h1 { color: #8FA89E; margin-bottom: 20px; }
.header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.logout-btn {
    padding: 10px 20px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}
.logout-btn:hover { background: #c82333; }
.stats {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}
.stat-card {
    flex: 1;
    padding: 20px;
    background: #f5f8f7;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}
.stat-card:hover { transform: scale(1.02); }
.stat-card.pending-active {
    background: #ffc107;
    color: #333;
}
.stat-card.pending-active .stat-number { color: #333; }
.stat-card.approved-active {
    background: #28a745;
    color: white;
}
.stat-card.approved-active .stat-number { color: white; }
.stat-card.rejected-active {
    background: #dc3545;
    color: white;
}
.stat-card.rejected-active .stat-number { color: white; }
.stat-number { font-size: 32px; font-weight: bold; color: #8FA89E; }
.stat-label { font-size: 14px; margin-top: 5px; }
.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}
.photo-card {
    border: 2px solid #ddd;
    border-radius: 10px;
    overflow: hidden;
    background: white;
}
.photo-card img {
    width: 100%;
    max-height: 400px;
    object-fit: contain;
    background: #1a1a1a;
}
.photo-info { padding: 15px; }
.caption {
    margin: 10px 0;
    color: #333;
    font-size: 16px;
    line-height: 1.4;
}
.status-actions {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.status-actions button {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 5px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.1s;
}
.status-actions button:hover { transform: scale(1.05); }
.status-actions button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}
.btn-to-pending { background: #ffc107; color: #333; }
.btn-to-approved { background: #28a745; color: white; }
.btn-to-rejected { background: #dc3545; color: white; }
.btn-delete {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-delete:hover { transform: scale(1.05); background: #5a6268; }
.timestamp { font-size: 12px; color: #666; margin-top: 5px; }
.empty { text-align: center; padding: 40px; color: #666; }
.hidden { display: none; }
{% endblock %}
{% block content %}
<div class="container">
    <div class="header-bar">
        <h1>Admin Dashboard</h1>
        <form method="POST" action="{{ url_for('admin_logout') }}" style="margin: 0;">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>

    <div class="stats">
        <div class="stat-card pending-active" id="pendingTab" onclick="showSection('pending')">
            <div class="stat-number" id="pendingCount">0</div>
            <div class="stat-label">Pending Review</div>
        </div>
        <div class="stat-card" id="approvedTab" onclick="showSection('approved')">
            <div class="stat-number" id="approvedCount">0</div>
            <div class="stat-label">Approved (Live)</div>
        </div>
        <div class="stat-card" id="rejectedTab" onclick="showSection('rejected')">
            <div class="stat-number" id="rejectedCount">0</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>

    <div id="pendingSection">
        <h2 style="margin-bottom: 15px;">üìã Pending Review</h2>
        <div id="pendingGrid" class="photo-grid">
            <div class="empty">Loading photos...</div>
        </div>
    </div>

    <div id="approvedSection" class="hidden">
        <h2 style="margin-bottom: 15px;">‚úÖ Approved Photos (Live on Display)</h2>
        <div id="approvedGrid" class="photo-grid">
            <div class="empty">Loading photos...</div>
        </div>
    </div>

    <div id="rejectedSection" class="hidden">
        <h2 style="margin-bottom: 15px;">‚ùå Rejected Photos</h2>
        <div id="rejectedGrid" class="photo-grid">
            <div class="empty">Loading photos...</div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let currentView = 'pending';

function showSection(section) {
    currentView = section;

    // Update tabs
    document.getElementById('pendingTab').className = 'stat-card' + (section === 'pending' ? ' pending-active' : '');
    document.getElementById('approvedTab').className = 'stat-card' + (section === 'approved' ? ' approved-active' : '');
    document.getElementById('rejectedTab').className = 'stat-card' + (section === 'rejected' ? ' rejected-active' : '');

    // Update sections
    document.getElementById('pendingSection').classList.toggle('hidden', section !== 'pending');
    document.getElementById('approvedSection').classList.toggle('hidden', section !== 'approved');
    document.getElementById('rejectedSection').classList.toggle('hidden', section !== 'rejected');
}

function createPhotoCard(photo, currentStatus) {
    const uploadTime = new Date(photo.uploaded_at).toLocaleString();
    const approveTime = photo.approved_at ? new Date(photo.approved_at).toLocaleString() : null;

    return `
        <div class="photo-card" id="photo-${photo.id}">
            <img src="/uploads/${photo.filename}" alt="Photo">
            <div class="photo-info">
                <div class="caption">${photo.caption}</div>
                <div class="timestamp">Uploaded: ${uploadTime}</div>
                ${approveTime ? `<div class="timestamp">Approved: ${approveTime}</div>` : ''}

                <div class="status-actions">
                    <button class="btn-to-pending" onclick="changeStatus(${photo.id}, 'pending')"
                            ${currentStatus === 'pending' ? 'disabled' : ''}>
                        Pending
                    </button>
                    <button class="btn-to-approved" onclick="changeStatus(${photo.id}, 'approved')"
                            ${currentStatus === 'approved' ? 'disabled' : ''}>
                        Approve
                    </button>
                    <button class="btn-to-rejected" onclick="changeStatus(${photo.id}, 'rejected')"
                            ${currentStatus === 'rejected' ? 'disabled' : ''}>
                        Reject
                    </button>
                </div>

                <button class="btn-delete" onclick="deletePhoto(${photo.id})">
                    Delete Permanently
                </button>
            </div>
        </div>
    `;
}

async function loadPhotos() {
    try {
        // Load pending
        const pendingResponse = await fetch('/api/photos?status=pending');
        const pendingPhotos = await pendingResponse.json();
        document.getElementById('pendingCount').textContent = pendingPhotos.length;

        const pendingGrid = document.getElementById('pendingGrid');
        pendingGrid.innerHTML = pendingPhotos.length === 0 ?
            '<div class="empty">No pending photos. Great job!</div>' :
            pendingPhotos.map(photo => createPhotoCard(photo, 'pending')).join('');

        // Load approved
        const approvedResponse = await fetch('/api/photos?status=approved');
        const approvedPhotos = await approvedResponse.json();
        document.getElementById('approvedCount').textContent = approvedPhotos.length;

        const approvedGrid = document.getElementById('approvedGrid');
        approvedGrid.innerHTML = approvedPhotos.length === 0 ?
            '<div class="empty">No approved photos yet.</div>' :
            approvedPhotos.map(photo => createPhotoCard(photo, 'approved')).join('');

        // Load rejected
        const rejectedResponse = await fetch('/api/photos?status=rejected');
        const rejectedPhotos = await rejectedResponse.json();
        document.getElementById('rejectedCount').textContent = rejectedPhotos.length;

        const rejectedGrid = document.getElementById('rejectedGrid');
        rejectedGrid.innerHTML = rejectedPhotos.length === 0 ?
            '<div class="empty">No rejected photos.</div>' :
            rejectedPhotos.map(photo => createPhotoCard(photo, 'rejected')).join('');

    } catch (error) {
        console.error('Error loading photos:', error);
        if (error.message && error.message.includes('401')) {
            window.location.href = '/admin';
        }
    }
}

async function changeStatus(id, newStatus) {
    const card = document.getElementById(`photo-${id}`);
    if (card) card.style.opacity = '0.5';

    try {
        let endpoint;
        if (newStatus === 'pending') {
            endpoint = `/api/photos/${id}/to-pending`;
        } else if (newStatus === 'approved') {
            endpoint = `/api/photos/${id}/approve`;
        } else if (newStatus === 'rejected') {
            endpoint = `/api/photos/${id}/reject`;
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            credentials: 'same-origin'
        });

        if (response.status === 401) {
            alert('Session expired. Please log in again.');
            window.location.href = '/admin';
            return;
        }

        if (response.ok) {
            setTimeout(() => loadPhotos(), 500);
        } else {
            if (card) card.style.opacity = '1';
            alert('Failed to change status');
        }
    } catch (error) {
        console.error('Error changing status:', error);
        if (card) card.style.opacity = '1';
    }
}

async function deletePhoto(id) {
    if (!confirm('Are you sure you want to permanently delete this photo? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/photos/${id}/delete`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        if (response.status === 401) {
            alert('Session expired. Please log in again.');
            window.location.href = '/admin';
            return;
        }

        if (response.ok) {
            const card = document.getElementById(`photo-${id}`);
            if (card) card.style.opacity = '0.5';
            setTimeout(() => loadPhotos(), 500);
        }
    } catch (error) {
        console.error('Error deleting photo:', error);
    }
}

// Load photos on page load
loadPhotos();

// Auto-refresh every 10 seconds
setInterval(loadPhotos, 10000);
</script>
{% endblock %}